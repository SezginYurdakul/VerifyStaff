# ðŸš€ VerifyStaff: Offline-First Attendance System

**VerifyStaff** is a lightweight, high-reliability attendance tracking solution designed for environments with unstable or no internet connection. It eliminates the need for expensive biometric hardware by using a secure, peer-to-peer QR scanning model.

---

## ðŸ“Œ Project Concept

The system operates on a **Representative-to-Worker** validation model:
1.  **Workers** generate a dynamic, time-synced QR code (no internet needed).
2.  **Representatives** scan these codes using their mobile device (works offline).
3.  **Data** is stored locally on the representative's device and synced to the **Laravel Server** once an internet connection is established.

---

## ðŸ›  Tech Stack

| Component | Technology | Role |
| :--- | :--- | :--- |
| **Backend** | Laravel 11 (PHP 8.3+) | Central database, Auth, Reporting API |
| **Frontend** | React (Vite) | Progressive Web App (PWA) interface |
| **Database** | MySQL / PostgreSQL | Server-side persistent storage |
| **Offline DB** | IndexedDB (Dexie.js) | Browser-side storage for offline logs |
| **Security** | TOTP Algorithm | Generates unhackable, 30-second QR codes |

---

## ðŸ“… 4-Stage Roadmap

### 1. Infrastructure & Backend (Laravel)
*Focus: The "Brain" and Administrative Control.*

- [ ] **Database Schema:** - `users`: (id, name, role [admin/rep/worker], secret_token, status).
    - `attendance_logs`: (id, worker_id, rep_id, type [in/out], device_time, sync_time).
- [ ] **Authentication:** Implementation of **Laravel Sanctum** for secure mobile-to-server communication.
- [ ] **Core APIs:**
    - `GET /api/v1/sync/staff`: To download the local worker validation list for Representatives.
    - `POST /api/v1/sync/logs`: To process bulk attendance uploads.



### 2. Frontend & PWA Integration (React)
*Focus: Mobile experience and Offline engine.*

- [ ] **PWA Configuration:** Setup `vite-plugin-pwa` to allow "Add to Home Screen" and offline asset caching.
- [ ] **Service Workers:** Logic to ensure the app opens instantly even in airplane mode.
- [ ] **IndexedDB Setup:** Creating a local mirror of the staff database to allow offline verification.



### 3. Dynamic QR & Security Logic
*Focus: Preventing fraud and screenshots.*

- [ ] **Worker Logic:**
    - TOTP-based QR generation (refreshes every 30s).
    - Visual "Live Feed" indicator (prevents using old screenshots).
- [ ] **Representative Logic:**
    - High-speed camera integration using `html5-qrcode`.
    - **Local Validation:** Comparing the QR timestamp with the representative's device clock.
- [ ] **Feedback System:** Haptic (vibration) and visual (green/red) feedback for scan results.



### 4. Testing & Sync Mechanism
*Focus: Data integrity and Deployment.*

- [ ] **Conflict Resolution:** Handling cases where device clocks might differ slightly (Â±1 min drift).
- [ ] **Auto-Sync:** Background logic to detect internet and push data automatically.
- [ ] **Deployment:** - VPS hosting for Laravel.
    - Deployment of React PWA.
    - Printing "How-to-Join" QR codes for easy staff onboarding.

---

## ðŸ”’ Security Measures
* **Time-Lock:** QR codes are valid for only 30 seconds.
* **Device Binding:** Each worker is tied to a specific `secret_token` generated by the server.
* **GPS Check:** (Optional) Representative's location is captured during the scan to ensure they are at the job site.

---

## âš ï¸ Critical Implementation Details

### 1. Clock Synchronization Strategy

**Problem:** TOTP uses 30-second windows, but devices may have clock drift up to Â±1 minute.

**Solution: Multi-Window TOTP Validation**
- Accept codes from **3 consecutive time windows**: previous (-30s), current, and next (+30s)
- This provides a **90-second effective validity window** while maintaining security
- Implementation:
  ```
  valid = TOTP.verify(code, secret, window: 1)  // window:1 = Â±1 step tolerance
  ```
- **Server-side drift detection:** Track which window codes are typically validated in. If a device consistently uses future/past windows, flag it for user notification
- **Optional NTP sync prompt:** When online, compare device time with server time. If drift > 30s, show a warning to the user to correct their device clock

### 2. Secret Token Secure Storage

**Problem:** `secret_token` stored in plain browser storage can be extracted by malicious scripts or device access.

**Solution: Multi-Layer Token Protection**

| Platform | Storage Method | Encryption |
|----------|---------------|------------|
| **iOS Safari** | IndexedDB + Keychain API (via Capacitor) | AES-256-GCM |
| **Android Chrome** | IndexedDB + Android Keystore (via Capacitor) | AES-256-GCM |
| **Desktop PWA** | IndexedDB | Web Crypto API (PBKDF2 + AES-GCM) |

**Implementation Details:**
- **Never store raw secret_token** - always encrypt before storage
- **Derive encryption key from:**
  - User's PIN/password (entered at app startup)
  - Device-specific salt (generated on first install, stored separately)
- **Token format in storage:** `{iv}:{encrypted_secret}:{auth_tag}`
- **Memory protection:** Clear decrypted token from memory after QR generation
- **Fallback for pure PWA:** Use Web Crypto API with user-provided PIN as key derivation input

### 3. Offline Data Conflict Resolution

**Problem:** Multiple scenarios can cause data conflicts:
- Same worker scanned by different reps
- Duplicate scans (network retry issues)
- Out-of-order sync when multiple reps sync at different times

**Solution: Event Sourcing with Deterministic Conflict Resolution**

**A. Unique Event Identification:**
```
event_id = SHA256(worker_id + rep_id + device_timestamp + scan_type)
```
- Server uses `event_id` as idempotency key - duplicate uploads are safely ignored

**B. Conflict Resolution Rules (Priority Order):**

| Conflict Type | Resolution Rule |
|--------------|-----------------|
| Duplicate exact scan | Keep first received, ignore duplicates (idempotent) |
| Same worker, same minute, different reps | Keep BOTH records, flag for admin review |
| Check-in without check-out | Auto-generate "missing checkout" at end of workday |
| Check-out without check-in | Flag as anomaly, require admin resolution |
| Future timestamp (device clock ahead) | Accept but normalize to server receive time |

**C. Sync Metadata:**
Each attendance log includes:
```json
{
  "event_id": "sha256_hash",
  "worker_id": 123,
  "rep_id": 456,
  "type": "in",
  "device_time": "2024-01-15T08:30:00Z",
  "device_timezone": "Europe/Istanbul",
  "sync_time": null,
  "sync_attempt": 1,
  "offline_duration_seconds": 28800
}
```

**D. Sync Queue Management:**
- IndexedDB stores logs with `sync_status`: `pending`, `syncing`, `synced`, `failed`
- On sync failure: exponential backoff (1s, 2s, 4s, 8s... max 5min)
- After 5 failed attempts: flag for manual review, continue with other logs

---

## ðŸ“ˆ Summary of Data Flow
1. **Morning (Online):** Rep syncs latest staff list.
2. **On-Site (Offline):** Rep scans workers. Logs saved to Representative's phone.
3. **Evening (Online):** App auto-detects internet and pushes logs to Laravel.
4. **Admin Dashboard:** Employer views real-time reports and exports Excel files.